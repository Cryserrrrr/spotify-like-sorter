<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Dashboard - Spotify Like Sorter</title>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #191414;
        color: white;
        min-height: 100vh;
      }

      .header {
        background: #1db954;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .header h1 {
        font-size: 1.5rem;
      }

      .header-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        cursor: pointer;
        text-decoration: none;
        transition: background 0.3s ease;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 2rem;
        padding: 2rem;
        height: calc(100vh - 80px);
      }

      .songs-section {
        background: #282828;
        border-radius: 15px;
        padding: 1.5rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .playlists-section {
        background: #282828;
        border-radius: 15px;
        padding: 1.5rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .section-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #404040;
      }

      .section-title {
        font-size: 1.3rem;
        font-weight: 600;
      }

      .counter {
        background: #1db954;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-left: auto;
      }

      .songs-list {
        flex: 1;
        overflow-y: auto;
        margin-right: -1rem;
        padding-right: 1rem;
      }

      .song-item {
        display: flex;
        align-items: center;
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        background: #383838;
        border-radius: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .song-item:hover {
        background: #404040;
        transform: translateY(-1px);
      }

      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #1a1a1a;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: #404040;
        border-radius: 4px;
        transition: background 0.3s ease;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #1db954;
      }

      ::-webkit-scrollbar-corner {
        background: #1a1a1a;
      }

      * {
        scrollbar-width: thin;
        scrollbar-color: #404040 #1a1a1a;
      }

      @media (hover: none) and (pointer: coarse) {
        .song-item:hover {
          transform: none;
        }

        .song-item:active {
          background: #404040;
          transform: scale(0.98);
        }

        .btn:hover {
          transform: none;
        }

        .btn:active {
          transform: scale(0.95);
          background: #1ed760;
        }

        .control-btn:hover {
          transform: none;
        }

        .control-btn:active {
          transform: scale(0.9);
          background: #1ed760;
        }

        .playlist-item:hover {
          transform: none;
        }

        .playlist-item:active {
          background: #404040;
          transform: scale(0.98);
        }
      }

      .song-item.selected {
        background: #2a2a2a;
        border: 2px solid #1db954;
        box-shadow: 0 0 8px rgba(29, 185, 84, 0.3);
      }

      .song-checkbox {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .song-checkbox input[type="checkbox"] {
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .song-cover {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        margin-right: 1rem;
        object-fit: cover;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
      }

      .song-cover:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
      }

      .song-cover.playing {
        border: 2px solid #1db954;
        box-shadow: 0 0 15px rgba(29, 185, 84, 0.6);
      }

      .play-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .song-cover:hover .play-overlay {
        opacity: 1;
      }

      .play-icon {
        color: white;
        font-size: 1.2rem;
      }

      .icon-play::before {
        content: "";
        width: 0;
        height: 0;
        border-left: 8px solid currentColor;
        border-top: 6px solid transparent;
        border-bottom: 6px solid transparent;
        display: inline-block;
        margin-left: 2px;
      }

      .icon-pause::before {
        content: "";
        width: 10px;
        height: 12px;
        background: linear-gradient(
          to right,
          currentColor 0%,
          currentColor 30%,
          transparent 30%,
          transparent 70%,
          currentColor 70%,
          currentColor 100%
        );
        display: inline-block;
      }

      .icon-prev::before {
        content: "";
        border-style: solid;
        border-width: 6px 8px 6px 0;
        border-color: transparent currentColor transparent transparent;
        display: inline-block;
        margin-right: 1px;
      }

      .icon-prev::after {
        content: "";
        width: 2px;
        height: 12px;
        background: currentColor;
        display: inline-block;
        margin-left: -2px;
      }

      .icon-next::before {
        content: "";
        width: 2px;
        height: 12px;
        background: currentColor;
        display: inline-block;
        margin-right: -1px;
      }

      .icon-next::after {
        content: "";
        border-style: solid;
        border-width: 6px 0 6px 8px;
        border-color: transparent transparent transparent currentColor;
        display: inline-block;
        margin-left: 1px;
      }

      .icon-volume::before {
        content: "";
        width: 4px;
        height: 8px;
        background: currentColor;
        display: inline-block;
        position: relative;
      }

      .icon-volume::after {
        content: "";
        width: 6px;
        height: 12px;
        border: 2px solid currentColor;
        border-left: none;
        border-radius: 0 4px 4px 0;
        display: inline-block;
        margin-left: -1px;
        background: transparent;
      }

      .song-info {
        flex: 1;
        min-width: 0;
      }

      .song-title {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.2rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .song-artist {
        color: #b3b3b3;
        font-size: 0.85rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .playlist-item {
        display: flex;
        align-items: center;
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        background: #383838;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .playlist-item:hover {
        background: #404040;
      }

      .playlist-item.active {
        background: #1db954;
      }

      .playlist-cover {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        margin-right: 0.8rem;
        object-fit: cover;
        background: #404040;
      }

      .playlist-info {
        flex: 1;
        min-width: 0;
      }

      .playlist-name {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.2rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .playlist-tracks {
        color: #b3b3b3;
        font-size: 0.8rem;
      }

      .action-buttons {
        display: flex;
        gap: 0.5rem;
      }

      .btn {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        flex: 1;
      }

      .btn-primary {
        background: #1db954;
        color: white;
      }

      .btn-primary:hover {
        background: #1ed760;
        transform: translateY(-1px);
      }

      .btn-secondary {
        background: #e22134;
        color: white;
      }

      .btn-secondary:hover {
        background: #ff4757;
        transform: translateY(-1px);
      }

      .btn:disabled {
        background: #404040;
        color: #666;
        cursor: not-allowed;
        transform: none;
      }

      .btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        background: #404040;
        color: white;
        border: none;
        border-radius: 15px;
        cursor: pointer;
        margin-left: 0.5rem;
      }

      .btn-small:hover {
        background: #555;
      }

      .filters-section {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 1rem;
        background: #202020;
        border-radius: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
      }

      .filter-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .filter-buttons .btn {
        flex: 1;
        min-width: 80px;
      }

      .filter-input {
        padding: 0.5rem;
        border: 1px solid #404040;
        border-radius: 5px;
        background: #282828;
        color: white;
        font-size: 0.9rem;
      }

      .filter-input:focus {
        outline: none;
        border-color: #1db954;
        box-shadow: 0 0 0 2px rgba(29, 185, 84, 0.2);
      }

      .filter-select {
        padding: 0.5rem;
        border: 1px solid #404040;
        border-radius: 5px;
        background: #282828;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .filter-select:focus {
        outline: none;
        border-color: #1db954;
        box-shadow: 0 0 0 2px rgba(29, 185, 84, 0.2);
      }

      .selection-controls {
        padding: 1rem 0;
        border-bottom: 1px solid #404040;
        margin-bottom: 1rem;
      }

      .selection-info {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #b3b3b3;
      }

      .player-controls {
        background: #282828;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-around;
        gap: 1rem;
        flex-wrap: nowrap;
        overflow: hidden;
      }

      .player-info {
        flex: 1;
        min-width: 0;
      }

      .current-track {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.2rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .current-artist {
        color: #b3b3b3;
        font-size: 0.8rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .play-controls {
        display: flex;
        gap: 0.5rem;
      }

      .control-btn {
        background: #1db954;
        color: white;
        border: none;
        padding: 0.5rem;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .control-btn:hover {
        background: #1ed760;
      }

      .control-btn:disabled {
        background: #404040;
        cursor: not-allowed;
        transform: none;
      }

      .volume-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 120px;
        flex-shrink: 0;
      }

      .volume-icon {
        width: 20px;
        height: 20px;
        filter: brightness(0) saturate(100%) invert(100%);
        flex-shrink: 0;
      }

      .volume-slider {
        width: 50px;
        height: 4px;
        background: #404040;
        border-radius: 2px;
        outline: none;
        cursor: pointer;
        -webkit-appearance: none;
        appearance: none;
      }

      .volume-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 12px;
        height: 12px;
        background: #1db954;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }

      .volume-slider::-moz-range-thumb {
        width: 12px;
        height: 12px;
        background: #1db954;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: #b3b3b3;
      }

      .status-message {
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 8px;
        text-align: center;
        display: none;
      }

      .status-success {
        background: rgba(29, 185, 84, 0.2);
        border: 1px solid #1db954;
        color: #1db954;
      }

      .status-error {
        background: rgba(226, 33, 52, 0.2);
        border: 1px solid #e22134;
        color: #e22134;
      }

      .mobile-filters-toggle {
        display: none;
        background: #1db954;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        margin-bottom: 0.5rem;
        width: 100%;
      }

      .mobile-filters-dropdown {
        display: none;
        background: #202020;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        flex-direction: column;
        gap: 0.75rem;
      }

      .mobile-filters-dropdown.open {
        display: flex;
      }

      @media (max-width: 768px) {
        body {
          padding-bottom: 120px; /* Space for fixed player */
        }

        .main-content {
          grid-template-columns: 1fr;
          gap: 0.5rem;
          padding: 0.5rem;
          margin-bottom: 0;
        }

        .header {
          padding: 0.5rem 1rem;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
          gap: 1rem;
        }

        .header h1 {
          font-size: 1.1rem;
          margin: 0;
          flex: 1;
        }

        .header-info {
          flex-direction: row;
          gap: 1rem;
          align-items: center;
        }

        .user-info {
          font-size: 0.8rem;
        }

        .logout-btn {
          padding: 0.4rem 0.8rem;
          font-size: 0.8rem;
        }

        .songs-section {
          padding: 0.5rem;
          margin-bottom: 0;
        }

        .playlists-section {
          padding: 0.5rem;
        }

        .filters-section {
          display: none;
        }

        .mobile-filters-toggle {
          display: block;
        }

        .filter-group {
          min-width: 100%;
        }

        .filter-input,
        .filter-select {
          font-size: 16px;
          padding: 0.6rem;
        }

        .songs-list {
          max-height: 60vh;
          overflow-y: auto;
        }

        .song-item {
          padding: 0.4rem;
          margin-bottom: 0.2rem;
          border-radius: 8px;
        }

        .song-cover {
          width: 35px;
          height: 35px;
        }

        .song-info {
          margin-left: 0.4rem;
        }

        .song-title {
          font-size: 0.8rem;
          line-height: 1.2;
        }

        .song-artist {
          font-size: 0.7rem;
          line-height: 1.2;
        }

        .player-controls {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: #1a1a1a;
          border-top: 1px solid #404040;
          padding: 0.75rem;
          gap: 0.5rem;
          z-index: 1000;
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
        }

        .player-info {
          flex: 1;
          min-width: 0;
          text-align: left;
        }

        .current-track {
          font-size: 0.8rem;
          margin-bottom: 0.1rem;
        }

        .current-artist {
          font-size: 0.7rem;
        }

        .play-controls {
          display: flex;
          gap: 0.5rem;
          align-items: center;
        }

        .volume-control {
          display: none;
        }

        .control-btn {
          width: 35px;
          height: 35px;
          min-width: 35px;
        }

        .selection-controls {
          padding: 0.5rem 0;
        }

        .selection-info {
          flex-direction: row;
          gap: 1rem;
          align-items: center;
          justify-content: space-between;
        }

        .action-buttons {
          flex-direction: row;
          gap: 0.5rem;
        }

        .btn {
          padding: 0.6rem 1rem;
          font-size: 0.8rem;
          flex: 1;
        }

        .playlist-item {
          padding: 0.4rem;
          margin-bottom: 0.2rem;
        }

        .playlist-cover {
          width: 30px;
          height: 30px;
        }

        .song-checkbox {
          top: 0.2rem;
          right: 0.2rem;
          width: 16px;
          height: 16px;
        }

        .play-overlay {
          width: 25px;
          height: 25px;
        }

        .play-overlay i {
          font-size: 10px;
        }

        ::-webkit-scrollbar {
          width: 4px;
          height: 4px;
        }

        ::-webkit-scrollbar-thumb {
          background: #404040;
        }

        ::-webkit-scrollbar-thumb:hover {
          background: #1db954;
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 0.5rem;
        }

        .header h1 {
          font-size: 1.1rem;
        }

        .songs-section,
        .playlists-section {
          padding: 0.75rem;
        }

        .song-item {
          padding: 0.4rem;
        }

        .song-cover {
          width: 35px;
          height: 35px;
        }

        .song-title {
          font-size: 0.8rem;
        }

        .song-artist {
          font-size: 0.7rem;
        }

        .control-btn {
          width: 35px;
          height: 35px;
        }

        .btn {
          padding: 0.6rem;
          font-size: 0.8rem;
        }

        .filter-input,
        .filter-select {
          padding: 0.6rem;
          font-size: 16px;
        }

        .volume-slider {
          width: 80px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>Spotify Like Sorter</h1>
      <div class="header-info">
        <div class="user-info">
          <span id="username">Loading...</span>
        </div>
        <a href="/logout" class="logout-btn">Logout</a>
      </div>
    </div>

    <div class="main-content">
      <div class="songs-section">
        <div class="section-header">
          <h2 class="section-title">Liked Songs</h2>
          <span id="songs-counter" class="counter">0</span>
        </div>

        <!-- Mobile Filters -->
        <button class="mobile-filters-toggle" onclick="toggleMobileFilters()">
          üîç Filters & Search
        </button>
        <div class="mobile-filters-dropdown" id="mobile-filters">
          <div class="filter-group">
            <input
              type="text"
              id="mobile-title-filter"
              class="filter-input"
              placeholder="Filter by title..."
            />
          </div>
          <div class="filter-group">
            <input
              type="text"
              id="mobile-artist-filter"
              class="filter-input"
              placeholder="Filter by artist..."
            />
          </div>
          <div class="filter-group">
            <div class="filter-buttons">
              <button id="select-all-btn-mobile" class="btn btn-small">
                Select All
              </button>
              <button id="clear-selection-btn-mobile" class="btn btn-small">
                Clear
              </button>
              <button id="mobile-clear-filters-btn" class="btn btn-small">
                Clear Filters
              </button>
            </div>
          </div>
        </div>

        <div class="filters-section">
          <div class="filter-group">
            <input
              type="text"
              id="title-filter"
              class="filter-input"
              placeholder="Filter by title..."
            />
          </div>
          <div class="filter-group">
            <input
              type="text"
              id="artist-filter"
              class="filter-input"
              placeholder="Filter by artist..."
            />
          </div>
          <div class="filter-group">
            <div class="filter-buttons">
              <button id="select-all-btn-desktop" class="btn btn-small">
                Select All
              </button>
              <button id="clear-selection-btn-desktop" class="btn btn-small">
                Clear
              </button>
              <button id="clear-filters-btn" class="btn btn-small">
                Clear Filters
              </button>
            </div>
          </div>
        </div>
        <div id="songs-list" class="songs-list">
          <div class="loading">Loading your liked songs...</div>
        </div>
      </div>

      <div class="playlists-section">
        <div class="player-controls" id="player-controls" style="display: none">
          <div class="player-info">
            <div class="current-track" id="current-track">No track playing</div>
            <div class="current-artist" id="current-artist">
              Select a song to play
            </div>
          </div>
          <div class="play-controls">
            <button
              class="control-btn"
              id="play-pause-btn"
              onclick="togglePlayback()"
            >
              <i class="icon-play"></i>
            </button>
          </div>
          <div class="volume-control">
            <img
              src="volume-speaker-svgrepo-com.svg"
              alt="Volume"
              class="volume-icon"
            />
            <input
              type="range"
              min="0"
              max="100"
              value="50"
              class="volume-slider"
              id="volume-slider"
              onchange="setVolume(this.value)"
            />
          </div>
        </div>

        <div class="section-header">
          <h2 class="section-title">Your Playlists</h2>
        </div>
        <div id="playlists-list" class="songs-list">
          <div class="loading">Loading playlists...</div>
        </div>

        <div class="selection-controls">
          <div class="selection-info">
            <span id="selection-count">0 selected</span>
          </div>
        </div>

        <div class="action-buttons">
          <button id="add-to-playlist-btn" class="btn btn-primary" disabled>
            Add to Playlist
          </button>
          <button id="remove-from-liked-btn" class="btn btn-secondary" disabled>
            Remove from Liked
          </button>
        </div>

        <div id="status-message" class="status-message"></div>
      </div>
    </div>

    <script>
      let likedSongs = [];
      let playlists = [];
      let selectedSongs = new Set();
      let selectedPlaylist = null;
      let player = null;
      let deviceId = null;
      let currentTrackUri = null;
      let isPlaying = false;
      let accessToken = null;
      let filteredSongs = [];
      let currentFilters = {
        title: "",
        artist: "",
      };

      async function init() {
        try {
          await loadUserData();
          await loadPlaylists();
          await loadLikedSongs();
          await initializeSpotifyPlayer();
        } catch (error) {
          showStatus("Error loading data. Please refresh the page.", "error");
        }
      }

      window.onSpotifyWebPlaybackSDKReady = () => {};

      async function initializeSpotifyPlayer() {
        let token = getCookie("access_token");

        if (!token) {
          try {
            const response = await fetch("/api/token");
            if (response.ok) {
              const data = await response.json();
              token = data.access_token;
            }
          } catch (error) {}
        }

        if (!token) {
          showStatus(
            "No access token found. Please logout and login again.",
            "error"
          );
          return;
        }

        accessToken = token;

        if (window.Spotify) {
          createSpotifyPlayer();
          return;
        }

        window.onSpotifyWebPlaybackSDKReady = () => {
          createSpotifyPlayer();
        };

        if (
          !document.querySelector(
            'script[src="https://sdk.scdn.co/spotify-player.js"]'
          )
        ) {
          const script = document.createElement("script");
          script.src = "https://sdk.scdn.co/spotify-player.js";
          script.onerror = () => {
            showStatus("Failed to load Spotify SDK", "error");
          };
          document.head.appendChild(script);
        }

        setTimeout(() => {
          if (!player) {
            showStatus(
              "Player initialization timeout. Check your internet connection and Spotify Premium status.",
              "error"
            );
          }
        }, 10000);
      }

      function createSpotifyPlayer() {
        try {
          player = new Spotify.Player({
            name: "Spotify Like Sorter Web Player",
            getOAuthToken: (cb) => {
              cb(accessToken);
            },
            volume: 0.05,
          });

          player.addListener("initialization_error", ({ message }) => {
            showStatus("Player initialization error: " + message, "error");
          });

          player.addListener("authentication_error", ({ message }) => {
            showStatus(
              "Authentication error: " +
                message +
                ". You need Spotify Premium and must re-login to grant streaming permissions.",
              "error"
            );
          });

          player.addListener("account_error", ({ message }) => {
            showStatus(
              "Account error: " +
                message +
                ". Spotify Premium required for music streaming.",
              "error"
            );
          });

          player.addListener("playback_error", ({ message }) => {
            showStatus("Playback error: " + message, "error");
          });

          player.addListener("ready", ({ device_id }) => {
            deviceId = device_id;
            document.getElementById("player-controls").style.display = "flex";
            showStatus(
              "Spotify player ready! You can now play music.",
              "success"
            );
          });

          player.addListener("not_ready", ({ device_id }) => {
            showStatus("Player went offline", "error");
          });

          player.addListener("player_state_changed", (state) => {
            if (!state) {
              return;
            }

            const track = state.track_window.current_track;
            if (track) {
              document.getElementById("current-track").textContent = track.name;
              document.getElementById("current-artist").textContent =
                track.artists.map((a) => a.name).join(", ");
              currentTrackUri = track.uri;
            }

            isPlaying = !state.paused;
            const playPauseBtn = document.getElementById("play-pause-btn");
            const playPauseIcon = playPauseBtn.querySelector("i");
            playPauseIcon.className = isPlaying ? "icon-pause" : "icon-play";

            updateSongPlayingState();
          });

          player.connect().then((success) => {
            if (!success) {
              showStatus(
                "Failed to connect to Spotify player. Please check your Spotify Premium status and re-login.",
                "error"
              );
            }
          });
        } catch (error) {
          showStatus(
            "Error creating Spotify player: " + error.message,
            "error"
          );
        }
      }

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      async function loadUserData() {
        const response = await fetch("/api/user");
        if (!response.ok) {
          throw new Error("Failed to load user data");
        }
        const userData = await response.json();
        document.getElementById("username").textContent =
          userData.display_name || "User";
      }

      async function loadLikedSongs() {
        showStatus("Loading your songs...", "success");
        const response = await fetch("/api/liked-songs");
        if (!response.ok) {
          throw new Error("Failed to load liked songs");
        }
        likedSongs = await response.json();
        setupFilters();
        applyFilters();
        showStatus(`Loaded ${likedSongs.length} songs!`, "success");
      }

      function setupFilters() {
        document
          .getElementById("title-filter")
          .addEventListener("input", (e) => {
            currentFilters.title = e.target.value.toLowerCase();
            applyFilters();
          });

        document
          .getElementById("artist-filter")
          .addEventListener("input", (e) => {
            currentFilters.artist = e.target.value.toLowerCase();
            applyFilters();
          });

        document
          .getElementById("clear-filters-btn")
          .addEventListener("click", () => {
            clearAllFilters();
          });

        document
          .getElementById("mobile-title-filter")
          .addEventListener("input", (e) => {
            currentFilters.title = e.target.value.toLowerCase();
            syncFilterValues();
            applyFilters();
          });

        document
          .getElementById("mobile-artist-filter")
          .addEventListener("input", (e) => {
            currentFilters.artist = e.target.value.toLowerCase();
            syncFilterValues();
            applyFilters();
          });

        const mobileClearFilters = document.getElementById(
          "mobile-clear-filters-btn"
        );
        if (mobileClearFilters) {
          mobileClearFilters.addEventListener("click", () => {
            clearAllFilters();
          });
        }

        const selectAllDesktop = document.getElementById(
          "select-all-btn-desktop"
        );
        if (selectAllDesktop) {
          selectAllDesktop.addEventListener("click", selectAllSongs);
        }

        const clearSelectionDesktop = document.getElementById(
          "clear-selection-btn-desktop"
        );
        if (clearSelectionDesktop) {
          clearSelectionDesktop.addEventListener("click", clearSelection);
        }

        const selectAllMobile = document.getElementById(
          "select-all-btn-mobile"
        );
        if (selectAllMobile) {
          selectAllMobile.addEventListener("click", selectAllSongs);
        }

        const clearSelectionMobile = document.getElementById(
          "clear-selection-btn-mobile"
        );
        if (clearSelectionMobile) {
          clearSelectionMobile.addEventListener("click", clearSelection);
        }
      }

      function toggleMobileFilters() {
        const dropdown = document.getElementById("mobile-filters");
        dropdown.classList.toggle("open");
      }

      function syncFilterValues() {
        const titleFilter = document.getElementById("title-filter");
        if (titleFilter) titleFilter.value = currentFilters.title;

        const artistFilter = document.getElementById("artist-filter");
        if (artistFilter) artistFilter.value = currentFilters.artist;

        const mobileTitleFilter = document.getElementById(
          "mobile-title-filter"
        );
        if (mobileTitleFilter) mobileTitleFilter.value = currentFilters.title;

        const mobileArtistFilter = document.getElementById(
          "mobile-artist-filter"
        );
        if (mobileArtistFilter)
          mobileArtistFilter.value = currentFilters.artist;
      }

      function clearAllFilters() {
        currentFilters = { title: "", artist: "" };
        syncFilterValues();
        applyFilters();
      }

      function applyFilters() {
        filteredSongs = likedSongs.filter((item, index) => {
          const track = item.track;
          if (!track) return false;

          const titleMatch =
            !currentFilters.title ||
            track.name.toLowerCase().includes(currentFilters.title);

          const artistMatch =
            !currentFilters.artist ||
            track.artists.some((artist) =>
              artist.name.toLowerCase().includes(currentFilters.artist)
            );

          return titleMatch && artistMatch;
        });

        displayFilteredSongs();
        document.getElementById("songs-counter").textContent =
          filteredSongs.length;
      }

      async function loadPlaylists() {
        const response = await fetch("/api/playlists");
        if (!response.ok) {
          throw new Error("Failed to load playlists");
        }
        playlists = await response.json();
        displayPlaylists();
      }

      function displayLikedSongs() {
        applyFilters();
      }

      function displayFilteredSongs() {
        const songsContainer = document.getElementById("songs-list");

        if (filteredSongs.length === 0) {
          songsContainer.innerHTML =
            '<div class="loading">No songs match your filters.</div>';
          return;
        }

        songsContainer.innerHTML = filteredSongs
          .map((item, filteredIndex) => {
            const track = item.track;
            const coverUrl =
              track.album.images[2]?.url || track.album.images[0]?.url || "";

            const originalIndex = likedSongs.indexOf(item);
            const isSelected = selectedSongs.has(originalIndex);

            const isCurrentlyPlaying =
              currentTrackUri && currentTrackUri === track.uri;

            return `
                      <div class="song-item ${
                        isSelected ? "selected" : ""
                      }" onclick="toggleSongSelection(${originalIndex})">
                          <div class="song-checkbox">
                            <input type="checkbox" ${
                              isSelected ? "checked" : ""
                            } onchange="toggleSongSelection(${originalIndex})" onclick="event.stopPropagation()">
                          </div>
                          <div class="song-cover-container" style="position: relative;">
                                                        <img src="${coverUrl}" alt="Album cover" class="song-cover ${
              isCurrentlyPlaying ? "playing" : ""
            }" 
                                 onclick="event.stopPropagation(); playTrack('${
                                   track.uri
                                 }')"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjNDA0MDQwIi8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjYjNiM2IzIiBmb250LXNpemU9IjEycHgiPjwvdGV4dD4KPC9zdmc+'">
                            <div class="play-overlay">
                              <i class="play-icon ${
                                isCurrentlyPlaying && isPlaying
                                  ? "icon-pause"
                                  : "icon-play"
                              }"></i>
                            </div>
                          </div>
                          <div class="song-info">
                              <div class="song-title">${track.name}</div>
                              <div class="song-artist">${track.artists
                                .map((a) => a.name)
                                .join(", ")}</div>
                          </div>
                      </div>
                  `;
          })
          .join("");

        updateSelectionUI();
      }

      function displayPlaylists() {
        const playlistsContainer = document.getElementById("playlists-list");

        if (playlists.length === 0) {
          playlistsContainer.innerHTML =
            '<div class="loading">No playlists found.</div>';
          return;
        }

        const sortedPlaylists = [...playlists].sort((a, b) => {
          return (b.tracks?.total || 0) - (a.tracks?.total || 0);
        });

        playlistsContainer.innerHTML = sortedPlaylists
          .map((playlist, sortedIndex) => {
            const coverUrl = playlist.images[0]?.url || "";
            return `
                    <div class="playlist-item" data-playlist-id="${
                      playlist.id
                    }" onclick="selectPlaylistById('${playlist.id}')">
                        <img src="${coverUrl}" alt="Playlist cover" class="playlist-cover"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjNDA0MDQwIi8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjYjNiM2IzIiBmb250LXNpemU9IjEwcHgiPvCfO68rPC90ZXh0Pgo8L3N2Zz4='">
                        <div class="playlist-info">
                            <div class="playlist-name">${playlist.name}</div>
                            <div class="playlist-tracks">${
                              playlist.tracks?.total || 0
                            } tracks</div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function toggleSongSelection(index) {
        if (selectedSongs.has(index)) {
          selectedSongs.delete(index);
        } else {
          selectedSongs.add(index);
        }
        displayFilteredSongs();
        updateActionButtons();
      }

      function selectAllSongs() {
        selectedSongs.clear();
        filteredSongs.forEach((item) => {
          const originalIndex = likedSongs.indexOf(item);
          selectedSongs.add(originalIndex);
        });
        displayFilteredSongs();
        updateActionButtons();
      }

      function clearSelection() {
        selectedSongs.clear();
        displayFilteredSongs();
        updateActionButtons();
      }

      function updateSelectionUI() {
        const selectionCount = document.getElementById("selection-count");
        const count = selectedSongs.size;
        selectionCount.textContent = `${count} selected`;
      }

      window.addEventListener("beforeunload", () => {
        if (player) {
          player.disconnect();
        }
      });

      async function playTrack(trackUri) {
        if (!player || !deviceId) {
          showStatus(
            "Player not ready. Please wait or refresh the page.",
            "error"
          );
          return;
        }

        if (currentTrackUri === trackUri) {
          await togglePlayback();
          return;
        }

        try {
          if (isPlaying) {
            await player.pause();
            await new Promise((resolve) => setTimeout(resolve, 100));
          }

          const response = await fetch(
            `https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`,
            {
              method: "PUT",
              body: JSON.stringify({ uris: [trackUri] }),
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          if (response.ok) {
            currentTrackUri = trackUri;
            updatePlayingIcons();
          } else if (response.status === 403) {
            showStatus("Spotify Premium required to play music", "error");
          } else if (response.status === 404) {
            await new Promise((resolve) => setTimeout(resolve, 500));
            const retryResponse = await fetch(
              `https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`,
              {
                method: "PUT",
                body: JSON.stringify({ uris: [trackUri] }),
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${accessToken}`,
                },
              }
            );
            if (retryResponse.ok) {
              currentTrackUri = trackUri;
              updatePlayingIcons();
            } else {
              showStatus("Error playing track", "error");
            }
          } else {
            showStatus("Error playing track", "error");
          }
        } catch (error) {
          showStatus("Error playing track", "error");
        }
      }

      async function togglePlayback() {
        if (!player) {
          showStatus("Player not ready", "error");
          return;
        }

        try {
          await player.togglePlay();
        } catch (error) {
          showStatus("Error controlling playback", "error");
        }
      }

      async function nextTrack() {
        if (!player) {
          showStatus("Player not ready", "error");
          return;
        }

        try {
          await player.nextTrack();
        } catch (error) {
          showStatus("Error skipping track", "error");
        }
      }

      async function previousTrack() {
        if (!player) {
          showStatus("Player not ready", "error");
          return;
        }

        try {
          await player.previousTrack();
        } catch (error) {
          showStatus("Error going to previous track", "error");
        }
      }

      async function setVolume(volume) {
        if (!player) {
          return;
        }

        try {
          await player.setVolume(volume / 600);
        } catch (error) {}
      }

      function updateSongPlayingState() {
        updatePlayingIcons();
      }

      function updatePlayingIcons() {
        document.querySelectorAll(".song-cover").forEach((img) => {
          const playOverlay = img.parentElement.querySelector(".play-icon");
          const trackUri = img.getAttribute("onclick").match(/'([^']+)'/)[1];

          if (currentTrackUri === trackUri) {
            img.classList.add("playing");
            if (playOverlay) {
              playOverlay.className = isPlaying
                ? "play-icon icon-pause"
                : "play-icon icon-play";
            }
          } else {
            img.classList.remove("playing");
            if (playOverlay) {
              playOverlay.className = "play-icon icon-play";
            }
          }
        });
      }

      function selectPlaylistById(playlistId) {
        document
          .querySelectorAll(".playlist-item")
          .forEach((item) => item.classList.remove("active"));

        document
          .querySelector(`[data-playlist-id="${playlistId}"]`)
          .classList.add("active");

        selectedPlaylist = playlists.find((p) => p.id === playlistId);
        updateActionButtons();
      }

      function updateActionButtons() {
        const addBtn = document.getElementById("add-to-playlist-btn");
        const removeBtn = document.getElementById("remove-from-liked-btn");

        const hasSelection = selectedSongs.size > 0;
        addBtn.disabled = !(hasSelection && selectedPlaylist);
        removeBtn.disabled = !hasSelection;

        const count = selectedSongs.size;
        if (count > 1) {
          addBtn.textContent = `Add ${count} to Playlist`;
          removeBtn.textContent = `Remove ${count} from Liked`;
        } else {
          addBtn.textContent = "Add to Playlist";
          removeBtn.textContent = "Remove from Liked";
        }
      }

      async function addToPlaylist() {
        if (selectedSongs.size === 0 || !selectedPlaylist) return;

        try {
          const trackUris = Array.from(selectedSongs).map(
            (index) => likedSongs[index].track.uri
          );

          const response = await fetch("/api/add-to-playlist", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              playlistId: selectedPlaylist.id,
              trackUris: trackUris,
            }),
          });

          if (!response.ok) {
            throw new Error("Failed to add to playlist");
          }

          const result = await response.json();
          const count = result.addedCount || selectedSongs.size;

          showStatus(
            `Added ${count} song${count > 1 ? "s" : ""} to "${
              selectedPlaylist.name
            }"`,
            "success"
          );
        } catch (error) {
          showStatus("Error adding songs to playlist", "error");
        }
      }

      async function removeFromLiked() {
        if (selectedSongs.size === 0) return;

        try {
          const trackIds = Array.from(selectedSongs).map(
            (index) => likedSongs[index].track.id
          );

          const response = await fetch("/api/remove-from-liked", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              trackIds: trackIds,
            }),
          });

          if (!response.ok) {
            throw new Error("Failed to remove from liked songs");
          }

          const selectedIndices = Array.from(selectedSongs).sort(
            (a, b) => b - a
          );
          selectedIndices.forEach((index) => {
            likedSongs.splice(index, 1);
          });

          selectedSongs.clear();
          displayLikedSongs();
          updateActionButtons();

          const result = await response.json();
          const count = result.removedCount || trackIds.length;
          showStatus(
            `Removed ${count} song${count > 1 ? "s" : ""} from liked songs`,
            "success"
          );
        } catch (error) {
          showStatus("Error removing songs from liked songs", "error");
        }
      }

      function showStatus(message, type) {
        const statusEl = document.getElementById("status-message");
        statusEl.textContent = message;
        statusEl.className = `status-message status-${type}`;
        statusEl.style.display = "block";

        setTimeout(() => {
          statusEl.style.display = "none";
        }, 3000);
      }

      document
        .getElementById("add-to-playlist-btn")
        .addEventListener("click", addToPlaylist);
      document
        .getElementById("remove-from-liked-btn")
        .addEventListener("click", removeFromLiked);

      init();
    </script>
  </body>
</html>
